trigger:
  branches:
    include:
      - main

pr: none

pool:
  vmImage: ubuntu-latest

variables:
  TF_VERSION: "1.6.6"
  TF_ENV_DIR: "environments/dev"
  TF_VARS_FILE: "dev.tfvars"
  PLAN_FILE: "tfplan"

steps:
  - checkout: self
    fetchDepth: 0

  - task: Bash@3
    displayName: Install Terraform $(TF_VERSION)
    inputs:
      targetType: inline
      script: |
        set -euo pipefail
        curl -sSLo /tmp/terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
        sudo unzip -o /tmp/terraform.zip -d /usr/local/bin
        terraform version

  # Auth + plan using Service Connection
  - task: AzureCLI@2
    displayName: Terraform init + plan (dev)
    inputs:
      azureSubscription: "YOUR-SERVICE-CONNECTION-NAME"
      scriptType: bash
      scriptLocation: inlineScript
      addSpnToEnvironment: true
      inlineScript: |
        set -euo pipefail

        # Export ARM_* so Terraform azurerm provider picks them up
        export ARM_CLIENT_ID="${servicePrincipalId}"
        export ARM_CLIENT_SECRET="${servicePrincipalKey}"
        export ARM_TENANT_ID="${tenantId}"
        export ARM_SUBSCRIPTION_ID="$(az account show --query id -o tsv)"

        export TF_IN_AUTOMATION=true

        cd "$(TF_ENV_DIR)"

        terraform init -input=false
        terraform plan \
          -input=false \
          -var-file="$(TF_VARS_FILE)" \
          -out="$(PLAN_FILE)"

        terraform show -no-color "$(PLAN_FILE)" > tfplan.txt

  # Publish the plan artifacts for apply-dev.yml to consume
  - publish: $(TF_ENV_DIR)/$(PLAN_FILE)
    artifact: tfplan-dev

  - publish: $(TF_ENV_DIR)/tfplan.txt
    artifact: tfplan-dev-text