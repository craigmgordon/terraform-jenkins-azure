trigger:
  branches:
    include:
      - main
  paths:
    include:
      - environments/dev/*
      - environments/_shared/*
      - modules/*
      - versions.tf

pr: none

pool:
  vmImage: ubuntu-latest

variables:
  TF_VERSION: "1.6.6"
  WORKING_DIR: "environments/dev"
  PLAN_FILE: "tfplan-dev"

steps:
  - checkout: self
    fetchDepth: 0

  - task: Bash@3
    displayName: Install Terraform $(TF_VERSION)
    inputs:
      targetType: inline
      script: |
        set -euo pipefail

        if ! command -v unzip >/dev/null 2>&1; then
          sudo apt-get update
          sudo apt-get install -y unzip
        fi

        if terraform version >/dev/null 2>&1; then
          echo "Terraform already installed:"
          terraform version
        else
          echo "Installing Terraform ${TF_VERSION}..."
          curl -sSLo /tmp/terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
          sudo unzip -o /tmp/terraform.zip -d /usr/local/bin
          rm -f /tmp/terraform.zip
          terraform version
        fi

  - task: Bash@3
    displayName: Terraform Init + Plan (dev)
    inputs:
      targetType: inline
      script: |
        set -euo pipefail
        cd "$(WORKING_DIR)"

        terraform init -input=false
        terraform plan \
          -input=false \
          -var-file=dev.tfvars \
          -out="$(Build.ArtifactStagingDirectory)/$(PLAN_FILE)" \
          -no-color

        terraform show -no-color "$(Build.ArtifactStagingDirectory)/$(PLAN_FILE)" \
          > "$(Build.ArtifactStagingDirectory)/$(PLAN_FILE).txt"

  - task: PublishPipelineArtifact@1
    displayName: Publish Terraform plan artifact (dev)
    inputs:
      targetPath: "$(Build.ArtifactStagingDirectory)"
      artifact: "terraform-plan-dev"
      publishLocation: "pipeline"
